<!DOCTYPE html>
<html>
<head>
    <title>üéß Audio Transcription Analysis</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <div class="container">
        <h1>üéß ASR Error-Analysis UI</h1>
        
        <div class="tabs">
            <button class="tab-button active" data-tab="model">ü§ñ Model</button>
            <button class="tab-button" data-tab="transcribe-recording">üéôÔ∏è Record </button>
            <button class="tab-button" data-tab="transcribe">üìÑ Transcribe File</button>
            <button class="tab-button" data-tab="compare">üîç Compare</button>
            <button class="tab-button" data-tab="benchmark">üìä Benchmark</button>
        </div>
        
        <!-- Model Tab -->
        <div id="model" class="tab-content active">
            <div class="model-section">
                <h2>ASR Model Selection</h2>
                <p class="section-description">Configure the ASR model for transcription. Select from available models in the list, set the language, adjust temperature, and add an optional prompt to guide the output. You can also test the connection to the ASR server. <br><br><b>PLEASE NOTE:</b> <br>1. Make sure you have enough RAM availableto run the model, <br>2. The model will need to be downloaded first. <br>3. Follow the terminal output to see status of downloading, loading and transcription.</p>
                
                <div class="server-config">
                    <label for="server-url">Server URL:</label>
                    <div class="url-controls">
                        <input type="text" id="server-url" class="url-input" value="http://localhost:8000">
                        <button id="test-connection" class="btn btn-secondary">üîÑ Test</button>
                    </div>
                </div>
                
                <div class="model-selector">
                    <label for="model-select">Select ASR Model:</label>
                    <div class="model-controls">
                        <select id="model-select" class="model-dropdown">
                            <option value="loading">Loading models...</option>
                        </select>
                        <button id="save-model" class="btn btn-primary">üíæ Load</button>
                    </div>
                </div>
                
                <div class="transcription-options">
                    <div class="option-group">
                        <label for="language">Language:</label>
                        <select id="language" class="option-select">
                            <!-- Will be populated from languages.json -->
                        </select>
                    </div>
                    <div class="option-group">
                        <label for="prompt">Prompt (optional):</label>
                        <input type="text" id="prompt" class="option-input" placeholder="Guide the model's style">
                    </div>
                    <div class="option-group">
                        <label for="temperature">Temperature:</label>
                        <input type="range" id="temperature" min="0" max="1" step="0.1" value="0">
                        <span id="temperature-value">0.0</span>
                    </div>
                    <div class="option-group">
                        <label for="response-format">Response Format:</label>
                        <select id="response-format" class="option-select">
                            <option value="json">JSON</option>
                            <option value="text">Text</option>
                            <option value="verbose_json">Verbose JSON</option>
                            <option value="srt">SRT</option>
                            <option value="vtt">VTT</option>
                        </select>
                    </div>
                </div>
                
                <div id="model-info" class="info-box">
                    <p>Currently selected model: <span id="current-model">Loading...</span></p>
                    <div id="model-capabilities" style="display: none;">
                        <p>Supported formats: <span id="supported-formats">Loading...</span></p>
                        <p>Available response formats: <span id="response-formats">Loading...</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Transcribe Tab -->
        <div id="transcribe" class="tab-content">
            <div class="upload-section">
                <h2>Upload Audio for Transcription</h2>
                <p class="section-description">Upload an audio file for transcription. This tool supports various formats (WAV, MP3, etc.) and provides word-level timestamps in the output.</p>
                <form id="transcribeForm">
                    <div>
                        <label class="btn btn-secondary" for="transcribe-audio">
                            üé§ Choose Audio File
                            <input type="file" id="transcribe-audio" name="audio" 
                               accept=".wav,.mp3,.mp4,.mpeg,.mpga,.m4a,.webm" required>
                        </label>
                        <div id="transcribeAudioFileName" class="file-name"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">üî§ Transcribe file</button>
                </form>
            </div>
            
            <div id="transcriptionResult" style="display: none;">
                <h3>Transcription Result</h3>
                <div class="result-columns">
                    <div class="result-column">
                        <h4>Formatted Text</h4>
                        <div class="transcript" id="result-text"></div>
                    </div>
                    <div class="result-column">
                        <h4>Raw JSON</h4>
                        <pre class="json-view" id="result-json"></pre>
                    </div>
                </div>
                <button id="downloadTranscript" class="btn btn-warning">üíæ Download Transcript (JSON)</button>
            </div>
        </div>
        
        <!-- Transcribe Recording Tab -->
        <div id="transcribe-recording" class="tab-content">
            <div class="upload-section">
                <h2>Record Audio for Transcription</h2>
                <p class="section-description">Record audio directly from your browser for instant transcription (requires microphone access). After recording, you can transcribe the audio and download both the recording and the transcript.</p>
                <div class="recorder-container">
                    <div class="recorder-buttons">
                        <button id="startRecord" class="btn btn-secondary">‚è∫Ô∏è Start Recording</button>
                        <button id="stopRecord" class="btn btn-secondary" disabled>‚èπÔ∏è Stop Recording</button>
                    </div>
                    <div id="recordingStatus" class="recording-status"></div>
                    <audio id="recordedAudio" controls style="display: none;"></audio>
                    <button id="downloadRecording" class="btn btn-warning" style="display: none;">üíæ Download Recording</button>
                </div>
                <button id="transcribeRecording" class="btn btn-primary" disabled>üî§ Transcribe Recording</button>
            </div>
            
            <div id="recordingTranscriptionResult" style="display: none;">
                <h3>Transcription Result</h3>
                <div class="result-columns">
                    <div class="result-column">
                        <h4>Formatted Text</h4>
                        <div class="transcript" id="recording-result-text"></div>
                    </div>
                    <div class="result-column">
                        <h4>Raw JSON</h4>
                        <pre class="json-view" id="recording-result-json"></pre>
                    </div>
                </div>
                <button id="downloadRecordingTranscript" class="btn btn-warning">üíæ Download Transcript (JSON)</button>
            </div>
        </div>
        
        <!-- Compare Tab -->
        <div id="compare" class="tab-content compare-tab">
            <div class="upload-section" id="uploadSection">
                <h2>Upload Files</h2>
                <p class="section-description">Upload an audio file and two corresponding JSON transcripts to compare them side-by-side. This feature enables synchronized playback, WER calculation, and qualitative rating to evaluate transcription accuracy.</p>
                <form id="uploadForm">
                    <div class="upload-form-buttons">
                        <div>
                            <label class="btn btn-secondary" for="audio">
                                üé§ Choose Audio File (WAV)
                                <input type="file" id="audio" name="audio" accept=".wav" required>
                            </label>
                            <div id="audioFileName" class="file-name"></div>
                        </div>
                        <div>
                            <label class="btn btn-secondary" for="transcript1">
                                üìù Choose Transcript 1 (JSON)
                                <input type="file" id="transcript1" name="transcript1" accept=".json" required>
                            </label>
                            <div id="transcript1FileName" class="file-name"></div>
                        </div>
                        <div>
                            <label class="btn btn-secondary" for="transcript2">
                                üìù Choose Transcript 2 (JSON)
                                <input type="file" id="transcript2" name="transcript2" accept=".json" required>
                            </label>
                            <div id="transcript2FileName" class="file-name"></div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary">‚ÜîÔ∏è Compare Transcripts</button>
                        <button type="button" id="startAnnotation" class="btn btn-secondary" style="display: none;">üìù Start Annotation</button>
                    </div>
                </form>
            </div>
            
            <div class="stats-section" id="statsSection" style="display: none;">
                <h3>Comparison Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Transcript 1 Words</div>
                        <div class="stat-value" id="transcript1Words">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Transcript 2 Words</div>
                        <div class="stat-value" id="transcript2Words">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Similarity (1-WER)</div>
                        <div class="stat-value" id="wer-value">-</div>
                    </div>
                </div>
            </div>
            
            <div class="player-section" id="playerSection" style="display: none;">
                <h3>Audio File</h3>
                <p class="section-description">Play the uploaded audio file. The position of the playback will highlight in the transcripts.</p>
                <audio id="audio-player" controls>
                    Your browser does not support the audio element.
                </audio>
                
                <div class="transcripts-section">
                    <h3>Transcripts</h3>
                    <p class="section-description">Click a word to move the playback to the position of the word.</p>
                    <div class="transcripts-container">
                        <div class="transcript-column">
                            <h3 class="transcript-title">Transcript 1</h3>
                            <div class="transcript-text-container">
                                <div class="transcript" id="transcript1-text"></div>
                            </div>
                        </div>
                        <div class="transcript-column">
                            <h3 class="transcript-title">Transcript 2</h3>
                            <div class="transcript-text-container">
                                <div class="transcript" id="transcript2-text"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="rating-section" id="ratingSection" style="display: none;">
                <h3>Rate Transcripts</h3>
                <div class="rating-columns">
                    <div class="rating-column">
                        <h4>Transcript 1 Ratings</h4>
                        <div id="transcript1-ratings" class="rating-form"></div>
                    </div>
                    <div class="rating-column">
                        <h4>Transcript 2 Ratings</h4>
                        <div id="transcript2-ratings" class="rating-form"></div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="submitRatings" class="btn btn-primary">üíæ Save Response</button>
                    <button id="downloadResponse" class="btn btn-warning" style="display: none;">üíæ Download Response</button>
                </div>
            </div>
        </div>
        
        <!-- Benchmark Tab -->
        <div id="benchmark" class="tab-content">
            <div class="benchmark-section">
                <h2>Batch Benchmark</h2>
                <p class="section-description">Batch process multiple audio files against their ground truth transcripts to evaluate model performance. The tool calculates metrics like WER and CER and allows you to export the detailed results.</p>
                
                <div class="settings-container">
                    <div class="benchmark-config">
                        <h3>Configuration</h3>
                        <div class="config-group">
                            <label for="ground-truth-format">Ground Truth Format:</label>
                            <select id="ground-truth-format" class="option-select">
                                <option value="json">JSON</option>
                                <option value="txt">Plain Text</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="naming-pattern">File Naming Pattern:</label>
                            <input type="text" id="naming-pattern" class="option-input" 
                                value="{audio_file}.json" placeholder="e.g., {audio_file}.json">
                        </div>
                    </div>
                    
                    <div class="current-settings-box">
                        <h4>Current Model Settings</h4>
                        <div class="settings-item">Model: <span id="settings-model"></span></div>
                        <div class="settings-item">Language: <span id="settings-language"></span></div>
                        <div class="settings-item">Temperature: <span id="settings-temperature"></span></div>
                        <div class="settings-item">Response Format: <span id="settings-format"></span></div>
                        <div class="settings-item">Prompt: <span id="settings-prompt"></span></div>
                    </div>
                </div>
                
                <div class="file-upload-section">
                    <div class="upload-group">
                        <label class="btn btn-secondary" for="batch-audio-files">
                            üìÇ Select Audio Files
                            <input type="file" id="batch-audio-files" multiple 
                                accept=".wav,.mp3,.mp4,.mpeg,.mpga,.m4a,.webm">
                        </label>
                        <div id="audio-files-list" class="files-list"></div>
                    </div>
                    
                    <div class="upload-group">
                        <label class="btn btn-secondary" for="ground-truth-files">
                            üìù Select Ground Truth Files
                            <input type="file" id="ground-truth-files" multiple 
                                accept=".json,.txt">
                        </label>
                        <div id="truth-files-list" class="files-list"></div>
                    </div>
                </div>
                
                <div class="benchmark-controls">
                    <button id="start-benchmark" class="btn btn-primary">‚ñ∂Ô∏è Start Benchmark</button>
                    <button id="stop-benchmark" class="btn btn-warning" disabled>‚èπÔ∏è Stop</button>
                </div>
                
                <div id="benchmark-progress" style="display: none;">
                    <h3>Progress</h3>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="benchmark-progress-bar"></div>
                        <div class="progress-text" id="benchmark-progress-text">0%</div>
                    </div>
                    <div id="current-file-status" class="status-text"></div>
                </div>
                
                <div id="benchmark-results" style="display: none;">
                    <h3>Results</h3>
                    <div class="results-summary">
                        <div class="summary-stats"></div>
                        <div class="error-analysis"></div>
                    </div>
                    <div class="detailed-results">
                        <table id="results-table">
                            <thead>
                                <tr>
                                    <th>File</th>
                                    <th>WER</th>
                                    <th>CER</th>
                                    <th>Inference Time</th>
                                    <th>Status</th>
                                    <th>Substitutions</th>
                                    <th>Deletions</th>
                                    <th>Insertions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentResultFile = null;
        
        // Tab switching logic
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Update active button
                document.querySelectorAll('.tab-button').forEach(btn => 
                    btn.classList.remove('active'));
                button.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => 
                    content.classList.remove('active'));
                document.getElementById(button.dataset.tab).classList.add('active');
                
                // Update settings display if benchmark tab is clicked
                if (button.dataset.tab === 'benchmark') {
                    document.getElementById('settings-model').textContent = document.getElementById('model-select').value;
                    document.getElementById('settings-language').textContent = document.getElementById('language').value;
                    document.getElementById('settings-temperature').textContent = document.getElementById('temperature').value;
                    document.getElementById('settings-format').textContent = document.getElementById('response-format').value;
                    document.getElementById('settings-prompt').textContent = document.getElementById('prompt').value || 'None';
                }
            });
        });
        
        // Load available models when page loads
        async function loadModels() {
            try {
                const serverUrl = document.getElementById('server-url').value;
                const response = await fetch(`${serverUrl}/models`);
                const data = await response.json();
                const select = document.getElementById('model-select');
                select.innerHTML = data.models.map(model => 
                    `<option value="${model}">${model}</option>`
                ).join('');
                
                // Get and display current model
                const currentResponse = await fetch(`${serverUrl}/current-model`);
                const currentData = await currentResponse.json();
                document.getElementById('current-model').textContent = currentData.current_model;
                
                // Get server capabilities
                const configResponse = await fetch(`${serverUrl}/audio/config`);
                const configData = await configResponse.json();
                document.getElementById('supported-formats').textContent = configData.supported_formats.join(', ');
                document.getElementById('response-formats').textContent = configData.response_formats.join(', ');
                document.getElementById('model-capabilities').style.display = 'block';
                
                // Update response format dropdowns
                const formatSelect = document.getElementById('response-format');
                if (formatSelect) {
                    formatSelect.innerHTML = configData.response_formats.map(format => 
                        `<option value="${format}">${format.toUpperCase()}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('Failed to load models:', error);
                alert('Failed to connect to server. Please check the URL and try again.');
            }
        }
        
        // Update temperature value display
        document.getElementById('temperature').addEventListener('input', (e) => {
            document.getElementById('temperature-value').textContent = e.target.value;
        });
        
        // Update current model when selection changes
        document.getElementById('model-select').addEventListener('change', async (e) => {
            document.getElementById('current-model').textContent = e.target.value;
        });
        
        // Handle model save
        document.getElementById('save-model').addEventListener('click', async () => {
            const modelId = document.getElementById('model-select').value;
            const formData = new FormData();
            formData.append('model_id', modelId);
            
            try {
                const response = await fetch(`${getServerUrl()}/change-model`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Model changed successfully!');
                } else {
                    throw new Error(data.error || 'Failed to change model');
                }
            } catch (error) {
                console.error('Failed to change model:', error);
                alert('‚ùå Failed to change model. Please try again.');
            }
        });
        
        // Test server connection
        document.getElementById('test-connection').addEventListener('click', async () => {
            try {
                const serverUrl = document.getElementById('server-url').value;
                const response = await fetch(`${serverUrl}/current-model`);
                const data = await response.json();
                alert('‚úÖ Connection successful!\nCurrent model: ' + data.current_model);
            } catch (error) {
                console.error('Connection test failed:', error);
                alert('‚ùå Failed to connect to server. Please check the URL and try again.');
            }
        });
        
        // Function to get transcription parameters
        function getTranscriptionParams() {
            return {
                language: document.getElementById('language').value,
                prompt: document.getElementById('prompt').value,
                temperature: document.getElementById('temperature').value,
                responseFormat: document.getElementById('response-format').value
            };
        }
        
        // Transcribe functionality
        document.getElementById('transcribeForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const modelId = document.getElementById('model-select').value;
            const params = getTranscriptionParams();
            
            formData.append('file', document.getElementById('transcribe-audio').files[0]);
            formData.append('model_id', modelId);
            if (params.language) formData.append('language', params.language);
            if (params.prompt) formData.append('prompt', params.prompt);
            formData.append('temperature', params.temperature);
            formData.append('response_format', params.responseFormat);
            
            try {
                const response = await fetch(`${getServerUrl()}/audio/transcriptions`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.words) {  // Check for words array instead of success flag
                    const transcriptHtml = data.words.map(word => 
                        `<span class="word" data-start="${word.start}" data-end="${word.end}">${word.text}</span>`
                    ).join(' ');
                    
                    document.getElementById('result-text').innerHTML = transcriptHtml;
                    document.getElementById('result-json').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('transcriptionResult').style.display = 'block';
                    
                    // Enable download button
                    document.getElementById('downloadTranscript').onclick = () => {
                        const blob = new Blob([JSON.stringify(data, null, 2)], 
                            {type: 'application/json'});
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'transcript.json';
                        a.click();
                        URL.revokeObjectURL(url);
                    };
                } else if (data.error) {
                    throw new Error(data.error);
                } else {
                    // Handle text-only response
                    document.getElementById('result-text').innerHTML = data.text || data;
                    document.getElementById('result-json').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('transcriptionResult').style.display = 'block';
                }
            } catch (error) {
                console.error('Transcription failed:', error);
                alert('Transcription failed. Please try again.');
            }
        };
        
        // File name display functionality
        ['audio', 'transcript1', 'transcript2'].forEach(id => {
            document.getElementById(id).addEventListener('change', function(e) {
                document.getElementById(id + 'FileName').textContent = 
                    e.target.files[0] ? e.target.files[0].name : '';
            });
        });
        
        document.getElementById('uploadForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('audio', document.getElementById('audio').files[0]);
            formData.append('transcript1', document.getElementById('transcript1').files[0]);
            formData.append('transcript2', document.getElementById('transcript2').files[0]);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Load audio player
                    document.getElementById('audio-player').src = `/assets/${data.audio}`;
                    
                    // Load transcripts
                    const [transcript1, transcript2] = await Promise.all([
                        fetch(`/assets/${data.transcript1}`).then(r => r.json()),
                        fetch(`/assets/${data.transcript2}`).then(r => r.json())
                    ]);
                    
                    // Update transcript titles and content
                    document.querySelector('.transcript-column:nth-child(1) .transcript-title').textContent = 
                        `Transcript 1: ${data.transcript1.replace('.json', '')}`;
                    document.querySelector('.transcript-column:nth-child(2) .transcript-title').textContent = 
                        `Transcript 2: ${data.transcript2.replace('.json', '')}`;
                    
                    // Create HTML for both transcripts
                    ['transcript1-text', 'transcript2-text'].forEach((elementId, index) => {
                        const transcript = index === 0 ? transcript1 : transcript2;
                        const transcriptHtml = transcript.words.map(word => 
                            `<span class="word" data-start="${word.start}" data-end="${word.end}">${word.text}</span>`
                        ).join(' ');
                        document.getElementById(elementId).innerHTML = transcriptHtml;
                    });
                    
                    // Show all sections in order
                    document.getElementById('statsSection').style.display = 'block';
                    document.getElementById('playerSection').style.display = 'block';
                    document.getElementById('startAnnotation').style.display = 'inline-flex';
                    
                    // Initialize synchronization
                    initSync();
                    
                    // Calculate and show statistics
                    const words1 = transcript1.words.map(w => w.text);
                    const words2 = transcript2.words.map(w => w.text);
                    
                    // Update statistics
                    document.getElementById('transcript1Words').textContent = words1.length;
                    document.getElementById('transcript2Words').textContent = words2.length;
                    
                    // Calculate and display WER
                    const wer = calculateWER(words1, words2);
                    document.getElementById('wer-value').textContent = 
                        `${(100 - (wer * 100)).toFixed(1)}%`;
                }
            } catch (error) {
                console.error('Upload failed:', error);
                alert('Upload failed. Please try again.');
            }
        };
        
        function initSync() {
            const audio = document.getElementById('audio-player');
            const words = document.querySelectorAll('.word');
            
            audio.ontimeupdate = () => {
                const currentTime = audio.currentTime;
                
                words.forEach(word => {
                    const start = parseFloat(word.dataset.start);
                    const end = parseFloat(word.dataset.end);
                    
                    if (currentTime >= start && currentTime <= end) {
                        word.classList.add('active');
                    } else {
                        word.classList.remove('active');
                    }
                });
                
                // Find the first active word in either transcript and scroll to it
                const activeWord = document.querySelector('.word.active');
                if (activeWord) {
                    activeWord.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center',
                        inline: 'nearest'
                    });
                }
            };
            
            // Add click handlers for words
            words.forEach(word => {
                word.onclick = () => {
                    audio.currentTime = parseFloat(word.dataset.start);
                    audio.play();
                };
            });
        }
        
        let mediaRecorder;
        let audioChunks = [];
        
        // Recording functionality
        document.getElementById('startRecord').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = document.getElementById('recordedAudio');
                    audio.src = audioUrl;
                    audio.style.display = 'block';
                    document.getElementById('transcribeRecording').disabled = false;
                    
                    // Show and enable download button
                    const downloadButton = document.getElementById('downloadRecording');
                    downloadButton.style.display = 'block';
                    downloadButton.onclick = () => {
                        const a = document.createElement('a');
                        a.href = audioUrl;
                        a.download = 'recording.wav';
                        a.click();
                    };
                };
                
                audioChunks = [];
                mediaRecorder.start();
                
                document.getElementById('startRecord').disabled = true;
                document.getElementById('stopRecord').disabled = false;
                document.getElementById('startRecord').classList.add('recording');
                document.getElementById('recordingStatus').textContent = 'Recording...';
                
            } catch (err) {
                console.error('Error accessing microphone:', err);
                alert('Error accessing microphone. Please ensure microphone permissions are granted.');
            }
        });
        
        document.getElementById('stopRecord').addEventListener('click', () => {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            
            document.getElementById('startRecord').disabled = false;
            document.getElementById('stopRecord').disabled = true;
            document.getElementById('startRecord').classList.remove('recording');
            document.getElementById('recordingStatus').textContent = 'Recording complete';
        });
        
        document.getElementById('transcribeRecording').addEventListener('click', async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const formData = new FormData();
            const modelId = document.getElementById('model-select').value;
            const params = getTranscriptionParams();
            
            formData.append('file', audioBlob, 'recording.wav');
            formData.append('model_id', modelId);
            if (params.language) formData.append('language', params.language);
            if (params.prompt) formData.append('prompt', params.prompt);
            formData.append('temperature', params.temperature);
            formData.append('response_format', params.responseFormat);
            
            try {
                const response = await fetch(`${getServerUrl()}/audio/transcriptions`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.words) {
                    const transcriptHtml = data.words.map(word => 
                        `<span class="word" data-start="${word.start}" data-end="${word.end}">${word.text}</span>`
                    ).join(' ');
                    document.getElementById('recording-result-text').innerHTML = transcriptHtml;
                    document.getElementById('recording-result-json').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('recordingTranscriptionResult').style.display = 'block';
                } else if (data.error) {
                    throw new Error(data.error);
                } else {
                    // Handle text-only response
                    document.getElementById('recording-result-text').innerHTML = data.text || data;
                    document.getElementById('recording-result-json').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('recordingTranscriptionResult').style.display = 'block';
                }
            } catch (error) {
                console.error('Transcription failed:', error);
                alert('Transcription failed. Please try again.');
            }
        });
        
        // Calculate WER between two arrays of words
        function calculateWER(reference, hypothesis) {
            const costs = Array(hypothesis.length + 1).fill(null)
                .map(() => Array(reference.length + 1).fill(null));
            
            // Initialize first row and column
            for (let i = 0; i <= hypothesis.length; i++) costs[i][0] = i;
            for (let j = 0; j <= reference.length; j++) costs[0][j] = j;
            
            // Fill in the rest of the matrix
            for (let i = 1; i <= hypothesis.length; i++) {
                for (let j = 1; j <= reference.length; j++) {
                    if (hypothesis[i-1].toLowerCase() === reference[j-1].toLowerCase()) {
                        costs[i][j] = costs[i-1][j-1];
                    } else {
                        costs[i][j] = Math.min(
                            costs[i-1][j] + 1,    // deletion
                            costs[i][j-1] + 1,    // insertion
                            costs[i-1][j-1] + 1   // substitution
                        );
                    }
                }
            }
            
            return costs[hypothesis.length][reference.length] / reference.length;
        }
        
        // Load rating config and create rating forms
        async function loadRatingConfig() {
            try {
                const response = await fetch('/ui/config.json');
                const config = await response.json();
                createRatingForms(config.transcript_ratings);
            } catch (error) {
                console.error('Failed to load rating config:', error);
            }
        }
        
        function createRatingForms(config) {
            const containers = ['transcript1-ratings', 'transcript2-ratings'];
            
            containers.forEach((containerId, transcriptIndex) => {
                const container = document.getElementById(containerId);
                config.scales.forEach(scale => {
                    const ratingItem = document.createElement('div');
                    ratingItem.className = 'rating-item';
                    
                    const label = document.createElement('div');
                    label.className = 'rating-label';
                    label.textContent = scale.label;
                    
                    const description = document.createElement('div');
                    description.className = 'rating-description';
                    description.textContent = scale.description;
                    
                    const likertScale = document.createElement('div');
                    likertScale.className = 'likert-scale';
                    
                    scale.options.forEach(option => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'likert-option';
                        
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = `transcript${transcriptIndex + 1}-${scale.id}`;
                        input.value = option.value;
                        input.id = `transcript${transcriptIndex + 1}-${scale.id}-${option.value}`;
                        
                        const optionLabel = document.createElement('label');
                        optionLabel.htmlFor = input.id;
                        optionLabel.textContent = option.label;
                        
                        optionDiv.appendChild(input);
                        optionDiv.appendChild(optionLabel);
                        likertScale.appendChild(optionDiv);
                    });
                    
                    ratingItem.appendChild(label);
                    ratingItem.appendChild(description);
                    ratingItem.appendChild(likertScale);
                    container.appendChild(ratingItem);
                });
            });
            
            // Show the rating section
            document.getElementById('ratingSection').style.display = 'block';
        }
        
        // Add validation function
        function validateRatings() {
            const requiredScales = ['accuracy', 'punctuation', 'timing'];  // Get these from config if needed
            const missing = [];
            
            // Check transcript 1
            requiredScales.forEach(scale => {
                if (!document.querySelector(`input[name="transcript1-${scale}"]:checked`)) {
                    missing.push(`Transcript 1 - ${scale}`);
                }
            });
            
            // Check transcript 2
            requiredScales.forEach(scale => {
                if (!document.querySelector(`input[name="transcript2-${scale}"]:checked`)) {
                    missing.push(`Transcript 2 - ${scale}`);
                }
            });
            
            return missing;
        }
        
        // Update the submit handler
        document.getElementById('submitRatings').onclick = async () => {
            // Validate all ratings are completed
            const missingRatings = validateRatings();
            if (missingRatings.length > 0) {
                alert(`Please complete all ratings before submitting.\n\nMissing ratings for:\n${missingRatings.join('\n')}`);
                return;
            }
            
            const ratings = {
                transcript1: {},
                transcript2: {}
            };
            
            // Collect ratings
            document.querySelectorAll('input[type="radio"]:checked').forEach(input => {
                const [transcript, scale] = input.name.split('-');
                ratings[transcript][scale] = parseInt(input.value);
            });
            
            try {
                const response = await fetch('/save_ratings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        result_file: currentResultFile,
                        ratings: ratings
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Response saved successfully!');
                    document.getElementById('downloadResponse').style.display = 'inline-flex';
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Failed to save ratings:', error);
                alert('Failed to save response. Please try again.');
            }
        };
        
        // Add download handler
        document.getElementById('downloadResponse').onclick = async () => {
            try {
                // Update the URL to use the new route
                const filename = currentResultFile.split('/').pop();  // Get just the filename
                const response = await fetch(`/results/${filename}`);
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Failed to download response:', error);
                alert('Failed to download response. Please try again.');
            }
        };
        
        // Add click handler for annotation button
        document.getElementById('startAnnotation').onclick = async () => {
            try {
                // Save initial metadata
                const response = await fetch('/save_metadata', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        audio: document.getElementById('audio').files[0].name,
                        transcript1: document.getElementById('transcript1').files[0].name,
                        transcript2: document.getElementById('transcript2').files[0].name,
                        wer: window.werScores || {}  // Add WER scores if available
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    currentResultFile = data.result_file;
                    await loadRatingConfig();
                    document.getElementById('ratingSection').scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Failed to save metadata:', error);
                alert('Failed to start annotation. Please try again.');
            }
        };
        
        // Function to get server URL
        function getServerUrl() {
            return document.getElementById('server-url').value;
        }
        
        // Benchmark functionality
        let selectedAudioFiles = [];
        let selectedTruthFiles = [];
        let benchmarkInProgress = false;
        
        // File selection handlers
        document.getElementById('batch-audio-files').addEventListener('change', (e) => {
            selectedAudioFiles = Array.from(e.target.files);
            document.getElementById('audio-files-list').innerHTML = selectedAudioFiles
                .map(file => `<div>üìÑ ${file.name}</div>`)
                .join('');
        });
        
        document.getElementById('ground-truth-files').addEventListener('change', (e) => {
            selectedTruthFiles = Array.from(e.target.files);
            document.getElementById('truth-files-list').innerHTML = selectedTruthFiles
                .map(file => `<div>üìù ${file.name}</div>`)
                .join('');
        });
        
        // Benchmark control handlers
        document.getElementById('start-benchmark').addEventListener('click', async () => {
            if (selectedAudioFiles.length === 0) {
                alert('Please select audio files to benchmark');
                return;
            }
            
            // Update settings display
            document.getElementById('settings-model').textContent = document.getElementById('model-select').value;
            document.getElementById('settings-language').textContent = document.getElementById('language').value;
            document.getElementById('settings-temperature').textContent = document.getElementById('temperature').value;
            document.getElementById('settings-format').textContent = document.getElementById('response-format').value;
            document.getElementById('settings-prompt').textContent = document.getElementById('prompt').value || 'None';
            
            // Check if response format is JSON
            const responseFormat = document.getElementById('response-format').value;
            if (responseFormat.toLowerCase() !== 'json') {
                alert('Response format must be set to JSON for benchmarking. Please change the response format in the Model tab.');
                return;
            }
            
            const config = {
                format: document.getElementById('ground-truth-format').value,
                pattern: document.getElementById('naming-pattern').value,
                model_id: document.getElementById('model-select').value,
                ...getTranscriptionParams()
            };
            console.log('Benchmark config:', config);  // Debug log
            
            try {
                benchmarkInProgress = true;
                document.getElementById('start-benchmark').disabled = true;
                document.getElementById('stop-benchmark').disabled = false;
                document.getElementById('benchmark-progress').style.display = 'block';
                document.getElementById('benchmark-results').style.display = 'none';
                
                // Start the benchmark process
                const formData = new FormData();
                selectedAudioFiles.forEach(file => formData.append('audio_files', file));
                selectedTruthFiles.forEach(file => formData.append('truth_files', file));
                formData.append('config', JSON.stringify(config));
                
                const response = await fetch(`${getServerUrl()}/benchmark/start`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to start benchmark');
                }
                
                if (data && data.success) {
                    startProgressPolling(data.benchmark_id);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Benchmark failed:', error);
                alert('Failed to start benchmark: ' + error.message);
                resetBenchmarkUI();
            }
        });
        
        document.getElementById('stop-benchmark').addEventListener('click', async () => {
            try {
                const response = await fetch(`${getServerUrl()}/benchmark/stop`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    resetBenchmarkUI();
                    alert('Benchmark stopped successfully');
                }
            } catch (error) {
                console.error('Failed to stop benchmark:', error);
            }
        });
        
        function resetBenchmarkUI() {
            benchmarkInProgress = false;
            document.getElementById('start-benchmark').disabled = false;
            document.getElementById('stop-benchmark').disabled = true;
            document.getElementById('benchmark-progress').style.display = 'none';
            document.getElementById('benchmark-progress-bar').style.width = '0%';
            document.getElementById('benchmark-progress-text').textContent = '0%';
            document.getElementById('current-file-status').textContent = '';
            // Reset file inputs
            document.getElementById('batch-audio-files').value = '';
            document.getElementById('ground-truth-files').value = '';
            // Clear file lists
            document.getElementById('audio-files-list').innerHTML = '';
            document.getElementById('truth-files-list').innerHTML = '';
            // Clear selected files arrays
            selectedAudioFiles = [];
            selectedTruthFiles = [];
        }
        
        async function startProgressPolling(benchmarkId) {
            while (benchmarkInProgress) {
                try {
                    const response = await fetch(`${getServerUrl()}/benchmark/status/${benchmarkId}`);
                    const data = await response.json();
                    
                    updateProgress(data.progress, data.current_file);
                    
                    if (data.status === 'completed') {
                        displayResults(data.results);
                        break;
                    } else if (data.status === 'failed') {
                        throw new Error(data.error);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    console.error('Progress polling failed:', error);
                    break;
                }
            }
        }
        
        function updateProgress(progress, currentFile) {
            document.getElementById('benchmark-progress-bar').style.width = `${progress}%`;
            document.getElementById('benchmark-progress-text').textContent = `${progress}%`;
            if (currentFile) {
                document.getElementById('current-file-status').textContent = 
                    `Processing: ${currentFile}`;
            }
        }
        
        function displayResults(results) {
            document.getElementById('benchmark-results').style.display = 'block';
            
            // Calculate summary statistics
            const totalFiles = results.length;
            const completedResults = results.filter(r => r.status === 'completed');
            const averageWer = completedResults.length > 0 
                ? completedResults.reduce((sum, r) => sum + r.wer, 0) / completedResults.length 
                : 0;
            const averageCer = completedResults.length > 0
                ? completedResults.reduce((sum, r) => sum + r.error_analysis.cer, 0) / completedResults.length
                : 0;
            const totalTime = completedResults.reduce((sum, r) => sum + r.inference_time, 0);
            
            // Update summary statistics
            const summaryStats = document.querySelector('.summary-stats');
            summaryStats.innerHTML = `
                <h4>Summary</h4>
                <p>Total Files: ${totalFiles}</p>
                <p>Average WER: ${averageWer.toFixed(4)}</p>
                <p>Average CER: ${averageCer.toFixed(4)}</p>
                <p>Total Inference Time: ${totalTime.toFixed(2)} s</p>
            `;
            
            // Store results for download
            window.currentBenchmarkResults = results;
            
            // Add download buttons container
            const downloadButtons = document.createElement('div');
            downloadButtons.style.display = 'flex';
            downloadButtons.style.gap = '10px';
            downloadButtons.style.marginTop = '20px';
            
            // JSON download button
            const jsonButton = document.createElement('button');
            jsonButton.onclick = downloadBenchmarkResults;
            jsonButton.className = 'btn btn-secondary';
            jsonButton.style.backgroundColor = '#6c757d';
            jsonButton.innerHTML = 'üíæ Download JSON';
            
            // Excel download button
            const excelButton = document.createElement('button');
            excelButton.onclick = downloadBenchmarkExcel;
            excelButton.className = 'btn btn-secondary';
            excelButton.style.backgroundColor = '#6c757d';
            excelButton.innerHTML = 'üìä Download Excel';
            
            downloadButtons.appendChild(jsonButton);
            downloadButtons.appendChild(excelButton);
            summaryStats.parentNode.insertBefore(downloadButtons, summaryStats.nextSibling);
            
            // Update detailed results table
            const tbody = document.querySelector('#results-table tbody');
            // Update table headers first
            const thead = document.querySelector('#results-table thead tr');
            thead.innerHTML = `
                <th>File</th>
                <th>WER</th>
                <th>CER</th>
                <th>Inference Time</th>
                <th>Status</th>
                <th>Substitutions</th>
                <th>Deletions</th>
                <th>Insertions</th>
            `;
            
            tbody.innerHTML = results.map(result => `
                <tr>
                    <td>${result.file}</td>
                    <td>${result.status === 'completed' ? result.wer.toFixed(4) : 'N/A'}</td>
                    <td>${result.status === 'completed' ? result.error_analysis.cer.toFixed(4) : 'N/A'}</td>
                    <td>${result.status === 'completed' ? result.inference_time.toFixed(2) : 'N/A'} s</td>
                    <td>${result.status}</td>
                    <td>${result.status === 'completed' ? result.error_analysis.substitutions : 'N/A'}</td>
                    <td>${result.status === 'completed' ? result.error_analysis.deletions : 'N/A'}</td>
                    <td>${result.status === 'completed' ? result.error_analysis.insertions : 'N/A'}</td>
                </tr>
            `).join('');
            
            resetBenchmarkUI();
        }
        
        async function downloadBenchmarkResults() {
            try {
                if (!window.currentBenchmarkResults) {
                    alert('No benchmark results available to download');
                    return;
                }
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `benchmark_${timestamp}.json`;
                
                const blob = new Blob([JSON.stringify({
                    status: "completed",
                    results: window.currentBenchmarkResults,
                    timestamp: new Date().toISOString()
                }, null, 2)], { type: 'application/json' });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Failed to download results:', error);
                alert('Failed to download results. Please try again.');
            }
        }
        
        // Load languages when page loads
        async function loadLanguages() {
            try {
                const response = await fetch(`${getServerUrl()}/languages`);
                const data = await response.json();
                const languageSelect = document.getElementById('language');
                
                // Clear existing options
                languageSelect.innerHTML = '';
                
                // Add options from languages.json
                data.languages.forEach(lang => {
                    const option = document.createElement('option');
                    option.value = lang;
                    option.textContent = lang.charAt(0).toUpperCase() + lang.slice(1); // Capitalize first letter
                    languageSelect.appendChild(option);
                });
                
                // Set default to Norwegian
                languageSelect.value = 'norwegian';
                console.log('Languages loaded:', data.languages); // Debug log
            } catch (error) {
                console.error('Failed to load languages:', error);
                // Add fallback options if loading fails
                const fallbackLanguages = ["norwegian", "danish", "swedish", "finnish", "english", "german"];
                languageSelect.innerHTML = fallbackLanguages.map(lang => 
                    `<option value="${lang}">${lang.charAt(0).toUpperCase() + lang.slice(1)}</option>`
                ).join('');
                languageSelect.value = 'norwegian';
            }
        }
        
        // Load models when page loads
        loadModels();
        loadLanguages();
        
        // Function to update settings display
        function updateSettingsDisplay() {
            if (document.querySelector('.tab-button[data-tab="benchmark"]').classList.contains('active')) {
                document.getElementById('settings-model').textContent = document.getElementById('model-select').value;
                document.getElementById('settings-language').textContent = document.getElementById('language').value;
                document.getElementById('settings-temperature').textContent = document.getElementById('temperature').value;
                document.getElementById('settings-format').textContent = document.getElementById('response-format').value;
                document.getElementById('settings-prompt').textContent = document.getElementById('prompt').value || 'None';
            }
        }
        
        // Add change listeners to all settings inputs
        document.getElementById('model-select').addEventListener('change', updateSettingsDisplay);
        document.getElementById('language').addEventListener('change', updateSettingsDisplay);
        document.getElementById('temperature').addEventListener('input', updateSettingsDisplay);
        document.getElementById('response-format').addEventListener('change', updateSettingsDisplay);
        document.getElementById('prompt').addEventListener('input', updateSettingsDisplay);
        
        async function downloadBenchmarkExcel() {
            try {
                if (!window.currentBenchmarkResults) {
                    alert('No benchmark results available to download');
                    return;
                }
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `benchmark_${timestamp}.xlsx`;
                
                // Create rows for Excel
                const rows = window.currentBenchmarkResults
                    .filter(result => result.status === 'completed')
                    .map(result => ({
                        file: result.file,
                        transcription: result.transcription.text,
                        reference: result.reference,
                        wer: result.wer,
                        cer: result.error_analysis.cer,
                        inference_time: result.inference_time,
                        substitutions: result.error_analysis.substitutions,
                        deletions: result.error_analysis.deletions,
                        insertions: result.error_analysis.insertions,
                        model_id: document.getElementById('model-select').value,
                        language: document.getElementById('language').value,
                        prompt: document.getElementById('prompt').value || '',
                        temperature: document.getElementById('temperature').value,
                        response_format: document.getElementById('response-format').value
                    }));
                
                const response = await fetch(`${getServerUrl()}/download/excel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(rows)
                });
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Failed to download Excel:', error);
                alert('Failed to download Excel file. Please try again.');
            }
        }
    </script>
</body>
</html> 